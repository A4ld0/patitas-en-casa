<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Alarmas – Patitas en Casa</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />

  <!-- FontAwesome (para íconos) -->
  <link
    href="https://use.fontawesome.com/releases/v5.1.1/css/all.css"
    rel="stylesheet"
    integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ"
    crossorigin="anonymous"
  />

  <link rel="stylesheet" href="style.css">

</head>
<body>

  <!-- ======= HEADER / NAVBAR ======= -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-brown">
      <div class="container-fluid">
        <a class="navbar-brand" href="home.html">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSDS2L1lcq2WKlLfrvJB-fhIGMD3P2fyFkFXQ&s"
               alt="Patitas en Casa" style="height:40px">
          Patitas en Casa
        </a>
        <button class="navbar-toggler" type="button"
                data-bs-toggle="collapse" data-bs-target="#navCollapse">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="d-flex align-items-center position-relative">
            <button class="btn btn-delifesti position-relative">
              <i class="fas fa-bell"></i>
              <span class="notification-badge" id="badge-count">0</span>
            </button>
          </div>
        </div>
      </div>
    </nav>
  </header>


  <!-- ======= MAIN ======= -->
  <main class="container my-5">
    <h2 class="text-center mb-4">Alarmas</h2>
    <div class="row gy-4">
      
      <!-- Crear Alarma -->
      <div class="col-lg-6">
        <div class="p-4 bg-brown text-white rounded">
          <h4>Crear Alarma</h4>
          <form id="alarmForm">
            <div class="row">
              <div class="col-md-6 mb-2">
                <input type="text" class="form-control" id="raza" placeholder="Raza" required>
              </div>
              <div class="col-md-6 mb-2">
                <input type="text" class="form-control" id="tipo" placeholder="Tipo" required>
              </div>
              <div class="col-md-6 mb-2">
                <input type="text" class="form-control" id="color" placeholder="Color">
              </div>
              <div class="col-md-6 mb-2">
                <input type="text" class="form-control" id="ciudad" placeholder="Ciudad">
              </div>
              <div class="col-md-6 mb-2">
                <input type="number" class="form-control" id="edad" placeholder="Edad">
              </div>
              <div class="col-md-6 mb-2">
                <select class="form-select" id="sexo">
                  <option value="" selected>Sexo</option>
                  <option value="Macho">Macho</option>
                  <option value="Hembra">Hembra</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn btn-light mt-2">Crear</button>
          </form>
        </div>
      </div>

      <!-- Alarmas actuales -->
      <div class="col-lg-6">
        <h5>Alarmas actuales</h5>
        <div id="alarmsList" class="list-group"></div>
      </div>
    </div>
  </main>


  <!-- ======= LOGIN MODAL ======= -->
  <div class="modal fade" id="loginModal" tabindex="-1"
       aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Cerrar"></button>
        </div>
        
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="email" class="form-label">Correo Electrónico</label>
              <input type="email" class="form-control" id="email"
                     placeholder="usuario@correo.com" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="password"
                     placeholder="Contraseña" required>
            </div>
            <button type="submit" class="btn btn-delifesti w-100">Entrar</button>
          </form>
        </div>

      </div>
    </div>
  </div>


  <!-- ======= BOOTSTRAP SCRIPTS ======= -->
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const listEl = document.getElementById('alarmsList');
  const badge  = document.getElementById('badge-count');
  let alarmas = [];

  // Función para cargar las alarmas del servidor
  async function cargarAlarmasDesdeServidor() {
    const token = localStorage.getItem('token');
    if (!token) {
      console.log('No hay token disponible');
      return;
    }

    try {
      const res = await fetch('http://localhost:3000/api/alarmas', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await res.json();
      if (res.ok) {
        console.log('Alarmas del usuario:', data);
        alarmas = data;
        localStorage.setItem('alarmas', JSON.stringify(alarmas));
        render();
      } else {
        console.error('Error al cargar alarmas:', data.error || data);
      }
    } catch (error) {
      console.error('Error al conectar con el servidor:', error);
    }
  }

  // Función que dibuja la lista de alarmas y actualiza el badge
  function render() {
  listEl.innerHTML = '';
  badge.textContent = alarmas.length;
  alarmas.forEach((a, i) => {
    const item = document.createElement('div');
    item.className = 'list-group-item d-flex justify-content-between';
    item.innerHTML = `
      <div>
        ${a.especie ? `<strong>Tipo:</strong> ${a.especie}<br>` : ''}
        ${a.raza    ? `<strong>Raza:</strong> ${a.raza}<br>` : ''}
        ${a.color   ? `<strong>Color:</strong> ${a.color}<br>` : ''}
        ${a.edadMax ? `<strong>Edad Máxima:</strong> ${a.edadMax}<br>` : ''}
        ${a.sexo    ? `<strong>Sexo:</strong> ${a.sexo}<br>` : ''}
        ${a.ciudad  ? `<strong>Ciudad:</strong> ${a.ciudad}<br>` : ''}
      </div>
      <button class="btn btn-sm btn-outline-danger">Eliminar</button>
    `;
    // Manejador para eliminar esta alarma
    item.querySelector('button').onclick = async () => {
  const confirmDelete = confirm('¿Seguro que deseas eliminar esta alarma?');
  if (!confirmDelete) return;

  const token = localStorage.getItem('token');
  if (!token) {
    alert('Debes iniciar sesión para eliminar alarmas.');
    return;
  }

  try {
    const res = await fetch(`http://localhost:3000/api/alarmas/${a._id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (res.status === 204) {
      console.log('Alarma eliminada.');
      
      // ✅ Filtra las alarmas que no sean la eliminada
      alarmas = alarmas.filter(al => al._id !== a._id);

      localStorage.setItem('alarmas', JSON.stringify(alarmas));
      render();  // ✅ Redibuja la lista sin recargar la página
    } else {
      const data = await res.json();
      console.error('Error al eliminar la alarma:', data.error || data);
      alert('No se pudo eliminar la alarma.');
    }
  } catch (error) {
    console.error('Error al conectar con el servidor:', error);
  }
};
    listEl.append(item);
  });
}


  // Render inicial y cargar desde el servidor
  render();
  cargarAlarmasDesdeServidor();

  // Crear nueva alarma desde el formulario
document.getElementById('alarmForm').onsubmit = async e => {
  e.preventDefault();
  const nueva = {
    especie: document.getElementById('tipo').value.trim(),
    raza:    document.getElementById('raza').value.trim(),
    color:   document.getElementById('color').value.trim(),
    ciudad:  document.getElementById('ciudad').value.trim(),
    edadMax: document.getElementById('edad').value.trim(),
    sexo:    document.getElementById('sexo').value
  };

  const token = localStorage.getItem('token');
  if (!token) {
    alert('Debes iniciar sesión para guardar alarmas en el servidor.');
    return;
  }

  try {
    const res = await fetch('http://localhost:3000/api/alarmas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(nueva)
    });

    const data = await res.json();

    if (res.ok) {
      console.log('Alarma guardada en el servidor:', data);
      e.target.reset();
      cargarAlarmasDesdeServidor();  // ✅ Vuelve a cargar para tener el _id real
    } else {
      console.error('Error al guardar en el servidor:', data.error || data);
      alert('Error al guardar la alarma en el servidor.');
    }
  } catch (error) {
    console.error('Error al conectar con el servidor:', error);
  }
};

});
</script>

</body>
</html>
